name: Fetch and Update Lookup Tables

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: bhud-static/flakysalt.CharacterKeybinds
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch GW2 API data
        run: |
          mkdir -p lookup_tables
          echo "Fetching profession IDs..."
          profession_ids=$(curl -s "https://api.guildwars2.com/v2/professions" | jq -r '.[]')
          echo "Found profession IDs: $profession_ids"

          echo "Fetching specialization IDs..."
          spec_ids=$(curl -s "https://api.guildwars2.com/v2/specializations" | jq -r '.[]')
          echo "Found specialization IDs: $spec_ids"

          for lang in en de fr es; do
            echo "Processing language: $lang"

            echo "[" > "lookup_tables/professions_${lang}.json"
            first=1
            for id in $profession_ids; do
              echo "Fetching profession $id for language $lang"
              if [ $first -eq 0 ]; then echo "," >> "lookup_tables/professions_${lang}.json"; fi
              curl -s "https://api.guildwars2.com/v2/professions/$id?lang=$lang" >> "lookup_tables/professions_${lang}.json"
              first=0
            done
            echo "]" >> "lookup_tables/professions_${lang}.json"

            echo "[" > "lookup_tables/specializations_${lang}.json"
            first=1
            for id in $spec_ids; do
              echo "Fetching specialization $id for language $lang"
              if [ $first -eq 0 ]; then echo "," >> "lookup_tables/specializations_${lang}.json"; fi
              curl -s "https://api.guildwars2.com/v2/specializations/$id?lang=$lang" >> "lookup_tables/specializations_${lang}.json"
              first=0
            done
            echo "]" >> "lookup_tables/specializations_${lang}.json"
          done
          echo "All data fetched successfully"

      - name: Commit and push changes
        env:
          TARGET_BRANCH: bhud-static/flakysalt.CharacterKeybinds
        run: |
          git add lookup_tables/
          git diff --staged --quiet || git commit -m "Automated update"
          git push origin $TARGET_BRANCH